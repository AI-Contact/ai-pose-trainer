<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìš´ë™ ë¶„ì„ ë°ëª¨</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .content {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
        padding: 20px;
      }

      .video-section {
        background: #f5f5f5;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
      }

      .video-container {
        position: relative;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .video-container img {
        width: 100%;
        height: auto;
        max-height: 80vh;
        object-fit: contain;
        display: block;
      }

      .controls {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .control-group label {
        font-weight: bold;
        color: #333;
      }

      select,
      button {
        padding: 12px 20px;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
      }

      select {
        background: white;
        color: #333;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-weight: bold;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .info-section {
        background: #f9f9f9;
        border-radius: 15px;
        padding: 20px;
      }

      .info-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .info-card h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.3em;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }

      .stat-item:last-child {
        border-bottom: none;
      }

      .stat-label {
        color: #666;
        font-weight: 500;
      }

      .stat-value {
        color: #333;
        font-weight: bold;
        font-size: 1.1em;
      }

      .feedback {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        font-size: 1.2em;
        font-weight: bold;
        margin-top: 10px;
      }

      .warmup {
        background: #ffa726;
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        font-size: 1.1em;
        margin-bottom: 15px;
      }

      .rep-scores {
        max-height: 200px;
        overflow-y: auto;
      }

      .rep-score-item {
        padding: 8px;
        background: #f0f0f0;
        border-radius: 5px;
        margin-bottom: 5px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 1024px) {
        .content {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ‹ï¸ ìš´ë™ ë¶„ì„ ë°ëª¨</h1>
        <p>ì‹¤ì‹œê°„ ìì„¸ ë¶„ì„ ë° í”¼ë“œë°± ì‹œìŠ¤í…œ</p>
      </div>

      <div class="content">
        <div class="video-section">
          <div class="video-container">
            <img id="videoStream" src="/video_feed" alt="ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°" />
          </div>

          <div class="controls">
            <div class="control-group">
              <label for="modeSelect">ëª¨ë“œ ì„ íƒ</label>
              <select id="modeSelect" onchange="onModeChange()">
                <option value="realtime">ì‹¤ì‹œê°„ (ì›¹ìº )</option>
                <option value="video">ë¹„ë””ì˜¤ ì—…ë¡œë“œ</option>
              </select>
            </div>

            <div
              class="control-group"
              id="videoUploadGroup"
              style="display: none"
            >
              <label for="videoFile">ë¹„ë””ì˜¤ íŒŒì¼</label>
              <input
                type="file"
                id="videoFile"
                accept="video/*"
                style="
                  padding: 8px;
                  border: 2px solid #667eea;
                  border-radius: 8px;
                  font-size: 14px;
                "
              />
              <div
                id="uploadStatus"
                style="display: none; margin-top: 10px; text-align: center"
              >
                <div
                  style="
                    display: inline-block;
                    padding: 10px;
                    background: #f0f0f0;
                    border-radius: 8px;
                  "
                >
                  <span
                    style="
                      display: inline-block;
                      width: 16px;
                      height: 16px;
                      border: 3px solid #667eea;
                      border-top-color: transparent;
                      border-radius: 50%;
                      animation: spin 1s linear infinite;
                      margin-right: 8px;
                    "
                  ></span>
                  <span style="color: #667eea; font-weight: bold"
                    >ì—…ë¡œë“œ ì¤‘...</span
                  >
                </div>
              </div>
            </div>

            <div class="control-group">
              <label for="exerciseSelect">ìš´ë™ ì„ íƒ</label>
              <select id="exerciseSelect">
                <option value="push_up">í‘¸ì‹œì—… (Push Up)</option>
                <option value="plank">í”Œë­í¬ (Plank)</option>
                <option value="crunch">í¬ëŸ°ì¹˜ (Crunch)</option>
                <option value="cross_lunge">í¬ë¡œìŠ¤ ëŸ°ì§€ (Cross Lunge)</option>
              </select>
            </div>

            <div class="control-group">
              <label>&nbsp;</label>
              <button id="startBtn" onclick="startExercise()">ì‹œì‘</button>
            </div>

            <div class="control-group">
              <label>&nbsp;</label>
              <button id="stopBtn" onclick="stopExercise()" disabled>
                ì¤‘ì§€
              </button>
            </div>
          </div>

          <!-- ë¶„ì„ ì™„ë£Œ ë©”ì‹œì§€ ë° ë‹¤ì‹œ í•˜ê¸° ë²„íŠ¼ -->
          <div
            id="analysisComplete"
            style="display: none; text-align: center; margin-top: 20px"
          >
            <div
              style="
                background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                color: white;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 15px;
              "
            >
              <h3 style="margin: 0 0 10px 0; font-size: 1.5em">
                âœ… ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆì–´ìš”!
              </h3>
            </div>
            <button
              id="resetBtn"
              onclick="resetAnalysis()"
              style="
                padding: 12px 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
              "
            >
              ë‹¤ì‹œ í•˜ê¸°
            </button>
          </div>
        </div>

        <div class="info-section">
          <div id="warmupAlert" class="warmup" style="display: none">
            ì¤€ë¹„ ì¤‘... <span id="warmupTime"></span>ì´ˆ ë‚¨ìŒ
          </div>

          <div class="info-card">
            <h3>ğŸ“Š í˜„ì¬ ìƒíƒœ</h3>
            <div class="stat-item">
              <span class="stat-label">ìš´ë™:</span>
              <span class="stat-value" id="currentExercise">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ìƒíƒœ:</span>
              <span class="stat-value" id="currentState">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ì¹´ìš´í„°:</span>
              <span class="stat-value" id="counters">-</span>
            </div>
          </div>

          <div class="info-card">
            <h3>ğŸ’¬ í”¼ë“œë°±</h3>
            <div id="feedback" class="feedback" style="display: none">
              <span id="feedbackText">-</span>
            </div>
          </div>

          <div class="info-card">
            <h3>ğŸ“ˆ ì ìˆ˜</h3>
            <div class="stat-item">
              <span class="stat-label">ì´ íšŸìˆ˜:</span>
              <span class="stat-value" id="repCount">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">í‰ê·  ì ìˆ˜:</span>
              <span class="stat-value" id="totalScore">-</span>
            </div>
            <div
              id="repScoresContainer"
              class="rep-scores"
              style="display: none"
            >
              <h4 style="margin-bottom: 10px">ê° íšŸìˆ˜ë³„ ì ìˆ˜:</h4>
              <div id="repScores"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let statusInterval = null;
      let uploadedVideoPath = null;

      function onModeChange() {
        const mode = document.getElementById("modeSelect").value;
        const videoUploadGroup = document.getElementById("videoUploadGroup");
        if (mode === "video") {
          videoUploadGroup.style.display = "flex";
        } else {
          videoUploadGroup.style.display = "none";
          uploadedVideoPath = null;
        }
      }

      function startExercise() {
        const exercise = document.getElementById("exerciseSelect").value;
        const mode = document.getElementById("modeSelect").value;

        if (mode === "video") {
          // ë¹„ë””ì˜¤ ì—…ë¡œë“œ ëª¨ë“œ
          const fileInput = document.getElementById("videoFile");
          if (!fileInput.files || fileInput.files.length === 0) {
            alert("ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          // ì—…ë¡œë“œ ìƒíƒœ í‘œì‹œ
          const uploadStatus = document.getElementById("uploadStatus");
          uploadStatus.style.display = "block";
          document.getElementById("startBtn").disabled = true;

          const formData = new FormData();
          formData.append("video", fileInput.files[0]);

          // ë¨¼ì € ë¹„ë””ì˜¤ ì—…ë¡œë“œ
          fetch("/api/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              // ì—…ë¡œë“œ ìƒíƒœ ìˆ¨ê¸°ê¸°
              uploadStatus.style.display = "none";
              document.getElementById("startBtn").disabled = false;

              if (data.success) {
                uploadedVideoPath = data.video_path;
                // ì—…ë¡œë“œ í›„ ë¶„ì„ ì‹œì‘
                startAnalysis(exercise, mode, data.video_path);
              } else {
                alert("ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì‹¤íŒ¨: " + data.message);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              // ì—…ë¡œë“œ ìƒíƒœ ìˆ¨ê¸°ê¸°
              uploadStatus.style.display = "none";
              document.getElementById("startBtn").disabled = false;
              alert("ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        } else {
          // ì‹¤ì‹œê°„ ëª¨ë“œ
          startAnalysis(exercise, mode, null);
        }
      }

      function startAnalysis(exercise, mode, videoPath) {
        // ë¶„ì„ ì™„ë£Œ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        const analysisComplete = document.getElementById("analysisComplete");
        analysisComplete.style.display = "none";

        // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë° ì¬ì‹œì‘ (ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„)
        const videoStream = document.getElementById("videoStream");
        videoStream.src = "/video_feed?t=" + new Date().getTime();

        fetch("/api/start", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            exercise: exercise,
            mode: mode,
            camera_id: 0,
            video_path: videoPath,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("startBtn").disabled = true;
              document.getElementById("stopBtn").disabled = false;
              document.getElementById("exerciseSelect").disabled = true;
              document.getElementById("modeSelect").disabled = true;

              // ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œì‘
              startStatusUpdates();
            } else {
              alert("ì˜¤ë¥˜: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("ìš´ë™ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }

      function stopExercise() {
        fetch("/api/stop", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("startBtn").disabled = false;
              document.getElementById("stopBtn").disabled = true;
              document.getElementById("exerciseSelect").disabled = false;

              // ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ì§€
              stopStatusUpdates();

              // ë¹„ë””ì˜¤ ëª¨ë“œì´ê³  repê°€ ìˆìœ¼ë©´ ë¶„ì„ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
              const mode = document.getElementById("modeSelect").value;
              if (mode === "video" && data.rep_count > 0) {
                showAnalysisComplete();
              } else if (data.rep_count > 0) {
                // ì‹¤ì‹œê°„ ëª¨ë“œì¼ ë•ŒëŠ” ì•Œë¦¼ë§Œ í‘œì‹œ
                alert(
                  `ìš´ë™ ì™„ë£Œ!\nì´ Rep: ${
                    data.rep_count
                  }\ní‰ê·  ì ìˆ˜: ${data.total_score.toFixed(3)}`
                );
              }
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function showAnalysisComplete() {
        const analysisComplete = document.getElementById("analysisComplete");
        analysisComplete.style.display = "block";
      }

      function resetAnalysis() {
        // ë¶„ì„ ì™„ë£Œ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        const analysisComplete = document.getElementById("analysisComplete");
        analysisComplete.style.display = "none";

        // ì—…ë¡œë“œ ìƒíƒœ ìˆ¨ê¸°ê¸°
        const uploadStatus = document.getElementById("uploadStatus");
        uploadStatus.style.display = "none";

        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        const fileInput = document.getElementById("videoFile");
        fileInput.value = "";
        uploadedVideoPath = null;

        // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("exerciseSelect").disabled = false;
        document.getElementById("modeSelect").disabled = false;

        // ìƒíƒœ ì •ë³´ ì´ˆê¸°í™”
        document.getElementById("currentExercise").textContent = "-";
        document.getElementById("currentState").textContent = "-";
        document.getElementById("counters").textContent = "-";
        document.getElementById("repCount").textContent = "0";
        document.getElementById("totalScore").textContent = "-";
        document.getElementById("feedback").style.display = "none";
        document.getElementById("repScoresContainer").style.display = "none";
        document.getElementById("warmupAlert").style.display = "none";

        // ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ì§€
        stopStatusUpdates();

        // ì„œë²„ ì¸¡ ìƒíƒœ ì´ˆê¸°í™” (ì—ëŸ¬ ë¬´ì‹œ)
        fetch("/api/stop", {
          method: "POST",
        }).catch((error) => {
          // ì—ëŸ¬ëŠ” ë¬´ì‹œ (ì´ë¯¸ ì •ë¦¬ëœ ìƒíƒœì¼ ìˆ˜ ìˆìŒ)
          console.log("Server state already reset or error ignored:", error);
        });
      }

      function startStatusUpdates() {
        statusInterval = setInterval(updateStatus, 500); // 0.5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
      }

      function stopStatusUpdates() {
        if (statusInterval) {
          clearInterval(statusInterval);
          statusInterval = null;
        }
      }

      function updateStatus() {
        fetch("/api/status")
          .then((response) => response.json())
          .then((data) => {
            // ë¹„ë””ì˜¤ ëª¨ë“œì—ì„œ ì‹¤í–‰ì´ ì¤‘ì§€ë˜ì—ˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì¤‘ì§€ ì²˜ë¦¬
            if (
              !data.is_realtime &&
              !data.is_running &&
              document.getElementById("startBtn").disabled
            ) {
              stopExercise();
              // ë¶„ì„ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
              showAnalysisComplete();
              return;
            }
            // ìš´ë™ ì •ë³´
            if (data.exercise) {
              document.getElementById("currentExercise").textContent =
                data.exercise.replace("_", " ").toUpperCase();
            }

            // ìƒíƒœ
            if (data.state) {
              document.getElementById("currentState").textContent = data.state;
            }

            // ì¹´ìš´í„°
            if (data.counters) {
              const counterText = Object.entries(data.counters)
                .map(([key, value]) => `${key}: ${value}`)
                .join(", ");
              document.getElementById("counters").textContent =
                counterText || "-";
            }

            // Warmup ì•Œë¦¼ (ì‹¤ì‹œê°„ ëª¨ë“œì¼ ë•Œë§Œ)
            const warmupAlert = document.getElementById("warmupAlert");
            if (
              data.is_realtime &&
              data.is_warmup &&
              data.warmup_remaining !== undefined
            ) {
              warmupAlert.style.display = "block";
              document.getElementById("warmupTime").textContent = Math.ceil(
                data.warmup_remaining
              );
            } else {
              warmupAlert.style.display = "none";
            }

            // í”¼ë“œë°±
            const feedbackDiv = document.getElementById("feedback");
            const feedbackText = document.getElementById("feedbackText");
            if (data.feedback_ko) {
              feedbackDiv.style.display = "block";
              feedbackText.textContent = data.feedback_ko;
            } else {
              feedbackDiv.style.display = "none";
            }

            // ì ìˆ˜
            if (data.rep_count !== undefined) {
              document.getElementById("repCount").textContent = data.rep_count;
            }

            if (data.total_score !== undefined && data.total_score !== null) {
              document.getElementById("totalScore").textContent =
                data.total_score.toFixed(3);
            }

            // Repë³„ ì ìˆ˜
            const repScoresContainer =
              document.getElementById("repScoresContainer");
            const repScoresDiv = document.getElementById("repScores");
            if (data.rep_scores && Object.keys(data.rep_scores).length > 0) {
              repScoresContainer.style.display = "block";
              repScoresDiv.innerHTML = "";
              for (const [rep, score] of Object.entries(data.rep_scores)) {
                const item = document.createElement("div");
                item.className = "rep-score-item";
                item.textContent = `Rep ${rep}: ${parseFloat(score).toFixed(
                  3
                )}`;
                repScoresDiv.appendChild(item);
              }
            } else {
              repScoresContainer.style.display = "none";
            }
          })
          .catch((error) => {
            console.error("Error updating status:", error);
          });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
      updateStatus();
    </script>
  </body>
</html>
